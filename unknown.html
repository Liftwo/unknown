<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Êú™Áü• Unknown ÈÅäÊà≤</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f5f5f5;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(17, 40px);
      grid-template-rows: repeat(17, 40px);
      gap: 2px;
      margin-bottom: 1rem;
    }
    .cell {
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      font-weight: bold;
      color: #000;
      border: 1px solid #ccc;
      position: relative;
    }
    .cell.empty {
      visibility: hidden;
    }
    .controls {
      margin-bottom: 1rem;
    }
    .playerCube {
      font-size: 10px;
      position: absolute;
      bottom: 0;
      left: 0;
      background: rgba(255,255,255,0.7);
      padding: 1px;
    }
    #turnInfo {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }
    .null { background-color: transparent; border: none; }
    .gray { background-color: #ccc; }
    .white { background-color: #fff; }
    .red { background-color: #EE4B2B; }
    .green { background-color: #6f6; }
    .blue { background-color: #0096FF; }
    .yellow { background-color: #ff6; }
    .purple { background-color: #c6f; }
    .pink { background-color: #f6c; }
    .lightblue { background-color: #6ff; }
    .orange { background-color: #fa3; }
    .black { background-color: #000; color: #fff; }
  </style>
</head>
<body>
  <h1>Êú™Áü• Unknown ÈÅäÊà≤</h1>

  <div class="controls">
    <label>ÈÅ∏ÊìáÁé©ÂÆ∂Ôºö</label>
    <select id="playerSelect"></select>
    <label>Ëµ∑ÂßãÊ†ºÂ≠êËôüÁ¢ºÔºö</label>
    <input type="number" id="startNumber" min="1" max="104" style="width: 60px;">
    <label>È†ÇÈù¢È°èËâ≤Ôºö</label>
    <select id="startTop">
      <option value="blue">Ëóç</option>
      <option value="red">Á¥Ö</option>
      <option value="green">Á∂†</option>
      <option value="yellow">ÈªÉ</option>
      <option value="purple">Á¥´</option>
      <option value="white">ÁôΩ</option>
    </select>
    <button onclick="setPlayerStart()">Ë®≠ÂÆö</button>
  </div>

  <div>
    <button onclick="move('up')">‰∏ä</button>
    <button onclick="move('down')">‰∏ã</button>
    <button onclick="move('left')">Â∑¶</button>
    <button onclick="move('right')">Âè≥</button>
  </div>

<!--  <div id="diceGuide" style="margin: 10px; padding: 10px; border: 1px solid #ccc; background: #fff; font-size: 14px;">-->
<!--  üé≤ È™∞Â≠êÂÖ≠Èù¢È°èËâ≤È†ÜÂ∫èÔºö<br>-->
<!--  <strong>‰∏äÔºö</strong> Ëóç (blue)Ôºå<strong>‰∏ãÔºö</strong> ÁôΩ (white)Ôºå<strong>Â∑¶Ôºö</strong> Á¥Ö (red)Ôºå-->
<!--  <strong>Âè≥Ôºö</strong> Á¥´ (purple)Ôºå<strong>ÂâçÔºö</strong> Á∂† (green)Ôºå<strong>ÂæåÔºö</strong> ÈªÉ (yellow)<br>-->
<!--  <em>ÂàùÂßãÈ†ÇÈù¢È°èËâ≤ÊúÉÂΩ±ÈüøÂÖ∂È§ò‰∫îÈù¢ÁöÑ‰ΩçÁΩÆ</em>-->
<!--  </div>-->
  <div id="cube-visuals" style="margin-top: 20px;"></div>

  <div id="turnInfo"></div>
  <div class="board" id="board"></div>


  <script>
    const boardData = [      [null, null, null, null, null, null, null, null, 4, null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null, 20, null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, 14, 24, null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, 34, 35, 36, 8, null, null, null, null, null, null],
      [null, null, null, null, null, 16, 52, 53, 54, 55, 56, null, null, null, null, null, null],
      [null, null, null, null, null, 75, 76, 77, 78, 79, 80, 57, 9, null, null, null, null],
      [null, null, null, 11, 51, 74, 93, 94, 95, 96, 81, 58, 37, null, null, null, null],
      [null, null, null, 33, 50, 73, 92, 103, 104, 97, 82, 59, 38, 25, 10, null, null],
      [3, 19, 23, 32, 49, 72, 91, 102, "G", 98, 83, 60, 39, 26, 21, 17, 2],
      [null, null,6, 31, 48, 71, 90, 101, 100, 99, 84, 61, 40, 27, null, null, null],
      [null, null, null,null, 47, 70, 89, 88, 87, 86, 85, 62, 41, 5, null, null, null],
      [null, null, null, null,12, 69, 68, 67, 66, 65, 64, 63, null, null, null, null, null],
      [null, null, null, null, null, 46, 45, 44, 43, 42, 7, null, null, null, null, null, null],
      [null, null, null, null, null, 15, 30, 29, 28, null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, 22, 13, null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, 18, null, null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, 1, null, null, null, null, null, null, null, null, null]];
    const colorMap = {  1: 'gray', 2: 'gray', 3: 'gray', 4: 'gray', 5: 'gray',
  6: 'gray', 7: 'gray', 8: 'gray', 9: 'gray', 10: 'gray',
  11: 'gray', 12: 'gray', 13: 'gray', 14: 'gray', 15: 'gray',
  16: 'gray', 17: 'white', 18: 'yellow', 19: 'blue', 20: 'green',
  21: 'yellow', 22: 'green', 23: 'red', 24: 'blue', 25: 'red',
  26: 'blue', 27: 'red', 28: 'purple', 29: 'white', 30: 'purple',
  31: 'purple', 32: 'blue', 33: 'white', 34: 'red', 35: 'green',
  36: 'white', 37: 'purple', 38: 'yellow',39: 'white', 40: 'blue', 41: 'green',
  42: 'white', 43: 'red', 44: 'blue', 45: 'blue', 46: 'yellow',
  47: 'white', 48: 'yellow', 49: 'green', 50: 'blue', 51: 'purple',
  52: 'yellow', 53: 'purple', 54: 'yellow', 55: 'red', 56: 'blue',
  57: 'white', 58: 'green', 59: 'blue', 60: 'green', 61: 'white',
  62: 'white', 63: 'purple', 64: 'green', 65: 'yellow', 66: 'purple',67: 'white',68: 'green',
  69: 'red', 70: 'purple', 71: 'red', 72: 'white', 73: 'yellow',
  74: 'red', 75: 'yellow', '76': 'white', 77: 'green', 78: 'red', 79: 'white',
  80: 'purple', 81: 'green', 82: 'white', 83: 'red', 84: 'yellow',
  85: 'purple', 86: 'white', 87: 'red', 88: 'red', 89: 'blue',
  90: 'white', 91: 'purple', 92:'green',93: 'purple', 94: 'yellow', 95: 'blue',
  96: 'purple', 97: 'yellow', 98: 'green', 99: 'green', 100: 'yellow',
  101: 'blue', 102: 'red', 103: 'white', 104: 'blue', 105: 'black',
  'G': 'black'}; // unchanged

  const players = [
    { id: 1, name: "Áé©ÂÆ∂1", x: undefined, y: undefined, cube: null, ready: false, banCount: 0, isBanished: false, extraMove: false, deferredRules: []},
    { id: 2, name: "Áé©ÂÆ∂2", x: undefined, y: undefined, cube: null, ready: false, banCount: 0, isBanished: false, extraMove: false, deferredRules: []},
    { id: 3, name: "Áé©ÂÆ∂3", x: undefined, y: undefined, cube: null, ready: false, banCount: 0, isBanished: false, extraMove: false, deferredRules: []},
    { id: 4, name: "Áé©ÂÆ∂4", x: undefined, y: undefined, cube: null, ready: false, banCount: 0, isBanished: false, extraMove: false, deferredRules: []},
  ];

    let currentPlayerIdx = 0;

  function createCube(topColor, facing = "front") {
    const cubeMap = {
    blue: {
    bottom: "red",
    front: { front: "purple", back: "green", left: "yellow", right: "white" },
    back: { front: "green", back: "purple", left: "white", right: "yellow" },
    right: { front: "yellow", back: "white", left: "green", right: "purple" },
    left: { front: "white", back: "yellow", left: "purple", right: "green" }
    },
    red: {
    bottom: "blue",
    right: { front: "yellow", back: "white", left: "purple", right: "green" },
    left: { front: "white", back: "yellow", left: "green", right: "purple" },
    front: { front: "green", back: "purple", left: "yellow", right: "white" },
    back: { front: "purple", back: "green", left: "white", right: "yellow" }
    },
    green: {
    bottom: "purple",
    back: { front: "red", back: "blue", left: "white", right: "yellow" },
    front: { front: "blue", back: "red", left: "yellow", right: "white" },
    right: { front: "yellow", back: "white", left: "red", right: "blue" },
    left: { front: "white", back: "yellow", left: "blue", right: "red" }
    },
    yellow: {
    bottom: "white",
    right: { front: "purple", back: "green", left: "red", right: "blue" },
    left: { front: "green", back: "purple", left: "blue", right: "red" },
    back: { front: "red", back: "blue", left: "green", right: "purple" },
    front: { front: "blue", back: "red", left: "purple", right: "green" }
    },
    purple: {
    bottom: "green",
    right: { front: "white", back: "yellow", left: "red", right: "blue" },
    left: { front: "yellow", back: "white", left: "blue", right: "red" },
    front: { front: "blue", back: "red", left: "white", right: "yellow" },
    back: { front: "red", back: "blue", left: "yellow", right: "white" }
    },
    white: {
    bottom: "yellow",
    front: { front: "purple", back: "green", left: "blue", right: "red" },
    back: { front: "green", back: "purple", left: "red", right: "blue" },
    left: { front: "blue", back: "red", left: "green", right: "purple" },
    right: { front: "red", back: "blue", left: "purple", right: "green" }
    }
    };

    const faceConfig = cubeMap[topColor]?.[facing];
    const bottom = cubeMap[topColor]?.bottom;

    if (!faceConfig || !bottom) {
    alert("createCube ÈÖçÁΩÆÈåØË™§ÔºåË´ãÊ™¢Êü•È†ÇÈù¢È°èËâ≤ËàáÊúùÂêëÊòØÂê¶Ê≠£Á¢∫");
    return null;
    }

    return {
    top: topColor,
    bottom: bottom,
    front: faceConfig.front,
    back: faceConfig.back,
    left: faceConfig.left,
    right: faceConfig.right,
    facing: facing
    };
    }


    function findPositionByNumber(n) {
      for (let y = 0; y < boardData.length; y++) {
        for (let x = 0; x < boardData[y].length; x++) {
          if (boardData[y][x] === n) return { x, y };
        }
      }
      return null;
    }

    function allPlayersReady() {
      return players.every(p => p.ready);
    }
    function setPlayerStart() {
      const playerIdx = parseInt(document.getElementById("playerSelect").value);
      const startNumber = parseInt(document.getElementById("startNumber").value);
      const topColor = document.getElementById("startTop").value.toLowerCase();

      const facing = prompt("Ë´ãËº∏ÂÖ•‰Ω†ÁöÑËáâÊúùÂêëÔºàfront / back / left / rightÔºâÔºö").toLowerCase();
      const validColors = ["blue", "red", "green", "yellow", "purple", "white"];
      const validFacings = ["front", "back", "left", "right"];

      if (!validColors.includes(topColor)) {
        alert("ÁÑ°ÊïàÈ†ÇÈù¢È°èËâ≤ÔºÅ");
        return;
      }

      if (!validFacings.includes(facing)) {
        alert("ÁÑ°ÊïàËáâÊúùÂêëÔºÅ");
        return;
      }

      const pos = findPositionByNumber(startNumber);
      if (!pos) {
        alert("ÁÑ°ÊïàÊ†ºÂ≠êËôüÁ¢º");
        return;
      }

      const cellColor = colorMap[startNumber];
      if (cellColor !== "gray") {
        alert("Âè™ËÉΩÂæûÁÅ∞Ëâ≤Ê†ºÂ≠êËµ∑Âßã");
        return;
      }

      const player = players[playerIdx];
      player.x = pos.x;
      player.y = pos.y;
      player.cube = createCube(topColor, facing);
      player.ready = true;
      drawBoard();

      if (allPlayersReady()) {
        currentPlayerIdx = 0;
        updateTurnInfo();
        alert("ÊâÄÊúâÁé©ÂÆ∂Â∑≤Ê∫ñÂÇôÂÆåÊàêÔºåËº™Âà∞„Äå" + players[currentPlayerIdx].name + "„ÄçÈñãÂßãÁßªÂãï„ÄÇ");
      }
      console.log("ÁõÆÂâçÁé©ÂÆ∂Ê∫ñÂÇôÁãÄÊÖãÔºö", players.map(p => p.ready));

    }


    function rotateCube(cube, dir) {
      const { top, bottom, front, back, left, right } = cube;
      let newCube = { ...cube };

      switch (dir) {
      case "down":
      newCube.top = front;
      newCube.front = bottom;
      newCube.bottom = back;
      newCube.back = top;
      newCube.facing = "down";
      break;
      case "up":
      newCube.top = back;
      newCube.back = bottom;
      newCube.bottom = front;
      newCube.front = top;
      newCube.facing = "up";
      break;
      case "left":
      newCube.top = right;
      newCube.right = bottom;
      newCube.bottom = left;
      newCube.left = top;
      newCube.facing = "left";
      break;
      case "right":
      newCube.top = left;
      newCube.left = bottom;
      newCube.bottom = right;
      newCube.right = top;
      newCube.facing = "right";
      break;
      }

      return newCube;
      }


  function checkRule1(player) {
    const posColor = colorMap[boardData[player.y][player.x]];
    if (player.cube.top === "white" || posColor === "white") {
      player.banCount++;
      player.isBanished = true;
      alert(`${player.name} Âõ†ÁÇ∫È†ÇÈù¢ÊàñÊ†ºÂ≠êÁÇ∫ÁôΩËâ≤ÔºåË¢´ÊîæÈÄêÔºÅÁ¥ØÁ©ç ${player.banCount} ÊûöÊîæÈÄêÊ®ôË®ò„ÄÇ`);

      let grayChoices = [];
      for (let y = 0; y < 17; y++) {
        for (let x = 0; x < 17; x++) {
          const num = boardData[y][x];
          if (num && colorMap[num] === "gray") {
            grayChoices.push({x, y, num});
          }
        }
      }

      if (grayChoices.length > 0) {
        let chosen;
        while (!chosen) {
          const grayStr = grayChoices.map(c => `Ê†ºÂ≠ê ${c.num} (${c.x},${c.y})`).join("\n");
          const selectedNum = prompt(`${player.name} Ë¢´ÊîæÈÄêÔºÅË´ãËº∏ÂÖ•‰Ω†ÊÉ≥ËøîÂõûÁöÑÁÅ∞Ëâ≤Ê†ºÂ≠êÁ∑®ËôüÔºö\n${grayStr}`);
          chosen = grayChoices.find(c => c.num == selectedNum);
          if (!chosen) {
            alert("Ëº∏ÂÖ•ÁÑ°ÊïàÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•ÁÅ∞Ëâ≤Ê†ºÂ≠êÁ∑®Ëôü„ÄÇ");
          }
        }

        if (chosen) {
          const topColor = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÈ†ÇÈù¢È°èËâ≤ÔºàËã±ÊñáÔºöblue, red, green, yellow, purple, whiteÔºâ");
          const validColors = ["blue", "red", "green", "yellow", "purple", "white"];
          if (validColors.includes(topColor)) {
            const facing = prompt("Ë´ãËº∏ÂÖ•È†ÇÈù¢ÊúùÂêëÔºàfront, back, left, rightÔºâ");
            const validFacings = ["front", "back", "left", "right"];
            if (validFacings.includes(facing)) {
              player.x = chosen.x;
              player.y = chosen.y;
              player.cube = createCube(topColor);
              player.justBanished = true;
              player.isBanished = false;
              alert(`${player.name} ËøîÂõûÁÅ∞Ëâ≤Ê†º ${chosen.num}ÔºåÈ†ÇÈù¢ÁÇ∫ ${topColor}ÔºåÊúùÂêëÁÇ∫ ${facing}`);
              currentPlayerIdx = (currentPlayerIdx + 1) % players.length;
              updateTurnInfo();
            } else {
              alert("Ëº∏ÂÖ•ÊúùÂêëÈåØË™§ÔºåÊú™Êõ¥ÊèõÊñπÂ°ä");
            }
          } else {
            alert("Ëº∏ÂÖ•ÈåØË™§ÔºåÈ†ÇÈù¢È°èËâ≤Êú™Êõ¥Êèõ„ÄÇÁ∂≠ÊåÅÂéüË®≠ÂÆö„ÄÇ");
          }

        }
      }
    }
  }

    function checkRule4And5(player) {
      const x = player.x;
      const y = player.y;
      const myColor = player.cube.top;
      const boardColors = [];

      for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
          const nx = x + dx;
          const ny = y + dy;
          if (nx >= 0 && nx < 17 && ny >= 0 && ny < 17) {
            const num = boardData[ny][nx];
            if (num !== null && colorMap[num]) {
              boardColors.push(colorMap[num]);
            }
          }
        }
      }

      // ‰∏çÂê´Ëá™Â∑±È†ÇÈù¢È°èËâ≤ÁöÑÊÉÖÊ≥Å‰∏ãÔºåÊâçÈúÄË¶ÅÊèõËâ≤
      if (!boardColors.includes(myColor)) {
        const possible = Array.from(new Set(boardColors)).filter(color => color !== myColor && color !== "gray");
        if (possible.length > 0) {
          const colorNameMap = {
            blue: 'Ëóç', red: 'Á¥Ö', green: 'Á∂†', yellow: 'ÈªÉ', purple: 'Á¥´', white: 'ÁôΩ'
          };
          let promptStr = `${player.name} ‰πùÂÆÆÊ†ºÂÖßÁÑ°ËàáÈ†ÇÈù¢Áõ∏ÂêåÁöÑÊ£ãÁõ§È°èËâ≤ÔºåË´ãËº∏ÂÖ•Êñ∞ÁöÑÈ†ÇÈù¢È°èËâ≤ÔºàËã±ÊñáÔºâÔºö
    `;
          promptStr += possible.map(c => `- ${colorNameMap[c] || c} (${c})`).join("");
          const choice = prompt(promptStr);
          const validFacings = ["front", "back", "left", "right"];
          if (choice && possible.includes(choice.toLowerCase())) {
            const topColor = choice.toLowerCase();
            const facing = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÈ†ÇÈù¢ÊúùÂêëÔºàfront, back, left, rightÔºâ");
            if (validFacings.includes(facing)) {
              player.cube = createCube(topColor, facing);
              alert(`${player.name} È†ÇÈù¢È°èËâ≤Êõ¥ÊèõÁÇ∫ ${topColor}ÔºåÊúùÂêëÁÇ∫ ${facing}`);
              checkRule6(player);
              if (checkRule8(player)) {
                alert(`${player.name} Á¨¶ÂêàÁ¨¨ÂÖ´Ê¢ùË¶èÂâáÔºåÂèØÈ°çÂ§ñÈÄ≤Ë°å‰∏ÄÊ¨°ÁßªÂãïÔºÅ`);
                drawBoard();
                return; // ‰∏çÊèõ‰∫∫ÔºåËÆìÁé©ÂÆ∂Á´ãÂç≥ÂÜçÁßªÂãï‰∏ÄÊ¨°
              }
            } else {
              alert("ÊúùÂêëËº∏ÂÖ•ÈåØË™§ÔºåÁ∂≠ÊåÅÂéüË®≠ÂÆö");
            }
          } else {
            alert("Ëº∏ÂÖ•ÈåØË™§ÔºåÁ∂≠ÊåÅÂéüÈ†ÇÈù¢");
          }
        }
      }
    }
function checkRule6(player) {
  const x = player.x;
  const y = player.y;
  const color = player.cube.top;
  let count = 0;

  // Ê™¢Êü•Âë®Âúç 3x3 Ê†ºÂ≠ê‰∏≠Áõ∏ÂêåÈ°èËâ≤ÁöÑÊï∏ÈáèÔºà‰∏çÂåÖÂê´Ëá™Â∑±ÁöÑ‰ΩçÁΩÆÔºâ
  for (let dy = -1; dy <= 1; dy++) {
    for (let dx = -1; dx <= 1; dx++) {
      if (dx === 0 && dy === 0) continue; // Ë∑≥ÈÅéËá™Â∑±ÁöÑ‰ΩçÁΩÆ
      const nx = x + dx;
      const ny = y + dy;
      if (nx >= 0 && nx < 17 && ny >= 0 && ny < 17) {
        const num = boardData[ny][nx];
        if (num !== null && colorMap[num] === color) {
          count++;
        }
      }
    }
  }
  console.log(`[Rule6] ${player.name} È†ÇÈù¢ ${color}Ôºå‰πùÂÆÆÊ†ºÂêåËâ≤Ê†ºÊï∏ = ${count}`);


  // Â¶ÇÊûúÂë®ÂúçÊúâ 2 ÂÄãÊàñ‰ª•‰∏äÁõ∏ÂêåÈ°èËâ≤ÁöÑÊ†ºÂ≠êÔºåËß∏ÁôºÁ¨¨ÂÖ≠Ê¢ùË¶èÂâá
  if (count >= 2) {
    const useAnyColor = player.cube.top === "yellow";
    const candidateList = players.filter(p => p !== player && (useAnyColor || p.cube.top === color));
    console.log(`[Rule6] ÂèØÈÅ∏ÊìáÁöÑÁõÆÊ®ôÁé©ÂÆ∂:`, candidateList.map(p => p.name));

    if (candidateList.length === 0) return;

    const nameList = candidateList.map((p, i) => `${i + 1}: ${p.name}`).join("\n");
    console.log(`[Rule6] ÂèØÈÅ∏ÊìáÁöÑÁõÆÊ®ôÁé©ÂÆ∂:`, candidateList.map(p => p.name));

  let target = null;
  while (!target) {
    const choiceIdx = prompt(`${player.name} Ëß∏ÁôºÁ¨¨ÂÖ≠Ê¢ùË¶èÂâáÔºöË´ãÈÅ∏Êìá‰∏Ä‰ΩçË¶ÅÂº∑Âà∂ÁßªÂãïÁöÑÁé©ÂÆ∂Ôºö\n${nameList}`);
    if (choiceIdx === null) {
      alert("Â∑≤ÂèñÊ∂àÈÅ∏Êìá");
      return;
    }
    const idx = parseInt(choiceIdx);
    if (!isNaN(idx) && idx >= 1 && idx <= candidateList.length) {
      target = candidateList[idx - 1];
    } else {
      alert("Ëº∏ÂÖ•ÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•ÊúâÊïàÁöÑÁ∑®Ëôü");
    }
  }


    const dirInput = prompt("Ë´ãËº∏ÂÖ•Ë¶ÅÁßªÂãïÁöÑÊñπÂêëÔºà‰∏ä: up, ‰∏ã: down, Â∑¶: left, Âè≥: rightÔºâÔºö");
    const dirMap = {
      up: { dx: 0, dy: -1 },
      down: { dx: 0, dy: 1 },
      left: { dx: -1, dy: 0 },
      right: { dx: 1, dy: 0 }
    };
    const dir = dirMap[dirInput];
    if (!dir) {
      alert("Ëº∏ÂÖ•ÊñπÂêëÈåØË™§ÔºåÊú™ÁßªÂãï");
      return;
    }

    const nx = target.x + dir.dx;
    const ny = target.y + dir.dy;
    const occupied = players.find(p => p.x === nx && p.y === ny);
    if (occupied) {
      const pushX = nx + dir.dx;
      const pushY = ny + dir.dy;
      if (
        pushX >= 0 && pushX < 17 && pushY >= 0 && pushY < 17 &&
        boardData[pushY][pushX] !== null &&
        !players.some(p => p.x === pushX && p.y === pushY)
      ) {
        // Êé®Èñã‰ΩîÊìöËÄÖ
        occupied.x = pushX;
        occupied.y = pushY;
        occupied.cube = rotateCube(occupied.cube, dirInput);  // ‚úÖ Ë¢´Êé®ËÄÖ‰πüÊóãËΩâ
        alert(`${occupied.name} Ë¢´ ${target.name} Êé®ÈñãËá≥ ${boardData[pushY][pushX]}`);
        checkRule1(occupied);
      } else {
        alert("ÁõÆÊ®ôÊ†ºË¢´‰ΩîÊìö‰∏îÁÑ°Ê≥ïÊé®ÈñãÔºåÁßªÂãïÂèñÊ∂à");
        return;
      }
    }

    // ‰∏çÁÆ°ÊòØÂéüÊú¨Á©∫Ê†ºÈÇÑÊòØÊé®ÈñãÂæåÔºåtarget ÈÉΩËÉΩÁßªÂãïÈÄ≤Ë©≤Ê†º
    target.x = nx;
    target.y = ny;
    target.cube = rotateCube(target.cube, dirInput);  // ‚úÖ ÁõÆÊ®ôÁé©ÂÆ∂ÊóãËΩâ
    alert(`${player.name} Âº∑Âà∂ÁßªÂãï ${target.name} Âêë ${dirInput} Ëá≥Ê†ºÂ≠ê ${boardData[ny][nx]}`);
    checkRule1(target);

  }
}


function checkRule8(player) {
  const color = player.cube.top;
  const x = player.x;
  const y = player.y;

  const directions = [
    { dx: 1, dy: 0 },
    { dx: 0, dy: 1 },
    { dx: 1, dy: 1 },
    { dx: 1, dy: -1 }
  ];

  const inBounds = (x, y) => x >= 0 && x < 17 && y >= 0 && y < 17;

  for (let { dx, dy } of directions) {
    let count = 1;

    // Âª∂‰º∏ÂâçÊñπ
    let nx = x + dx, ny = y + dy;
    while (inBounds(nx, ny) && colorMap[boardData[ny][nx]] === color) {
      count++;
      nx += dx;
      ny += dy;
    }

    // Âª∂‰º∏ÂèçÊñπÂêë
    nx = x - dx, ny = y - dy;
    while (inBounds(nx, ny) && colorMap[boardData[ny][nx]] === color) {
      count++;
      nx -= dx;
      ny -= dy;
    }

    if (count >= 3) {
      alert(`${player.name} Ëß∏ÁôºÁ¨¨ÂÖ´Ê¢ùË¶èÂâáÔºöÂΩ¢Êàê‰∏ÄÁõ¥Á∑öÔºåÂèØÈ°çÂ§ñÁßªÂãï‰∏ÄÊ¨°`);
      player.extraMove = true; // ‚úÖ Âª∂ÂæåÈ°çÂ§ñÁßªÂãïËôïÁêÜ

      // ÊåáÂÆöÂè¶‰∏ÄÂêçÂêåËâ≤È†ÇÈù¢Áé©ÂÆ∂ÂÜçÁßªÂãï‰∏ÄÊ≠•
      const sameColorPlayers = players.filter(p => p !== player && p.cube.top === color);
      if (sameColorPlayers.length > 0) {
        const nameList = sameColorPlayers.map((p, i) => `${i + 1}: ${p.name}`).join("\n");
        const choiceIdx = prompt(`‰Ω†ÂèØ‰ª•ÊåáÂÆö‰∏Ä‰ΩçÂêåËâ≤È†ÇÈù¢ÁöÑÁé©ÂÆ∂ÂÜçÁßªÂãï‰∏ÄÊ≠•Ôºö\n${nameList}`);
        const idx = parseInt(choiceIdx);
        const target = sameColorPlayers[idx - 1];
        if (!target) return true;

        const dirInput = prompt("Ë´ãËº∏ÂÖ•Ë©≤Áé©ÂÆ∂ÁöÑÁßªÂãïÊñπÂêëÔºàup/down/left/rightÔºâÔºö");
        const dirMap = {
          up: { dx: 0, dy: -1 },
          down: { dx: 0, dy: 1 },
          left: { dx: -1, dy: 0 },
          right: { dx: 1, dy: 0 }
        };
        const dir = dirMap[dirInput];
        if (!dir) return true;

        const tx = target.x + dir.dx;
        const ty = target.y + dir.dy;
        if (
          inBounds(tx, ty) &&
          boardData[ty][tx] !== null &&
          !players.some(p => p.x === tx && p.y === ty)
        ) {
          target.x = tx;
          target.y = ty;
          target.cube = rotateCube(target.cube, dirInput);
          alert(`${target.name} Âêë ${dirInput} ÁßªÂãïËá≥ ${boardData[ty][tx]}`);

          // ‚ö†Ô∏è ‰∏çÈ¶¨‰∏äËß∏Áôº rule6/8ÔºåËÄåÊòØÂª∂ÂæåËôïÁêÜ
          target.deferredRules.push("rule6");
          target.deferredRules.push("rule8");

          checkRule1(target); // ÊîæÈÄê‰ªçÁ´ãÂç≥ËôïÁêÜ
        }
      }

      return true;
    }
  }

  return false;
}



function move(dir) {
  const player = players[currentPlayerIdx];
  if (!allPlayersReady()) {
    alert("ÊâÄÊúâÁé©ÂÆ∂Â∞öÊú™Ë®≠ÂÆöËµ∑Âßã‰ΩçÁΩÆÔºåË´ãÂÖàÂÆåÊàêË®≠ÂÆö„ÄÇ");
    return;
  }


  if (player.x === undefined || player.y === undefined) return;

  const dx = dir === 'left' ? -1 : dir === 'right' ? 1 : 0;
  const dy = dir === 'up' ? -1 : dir === 'down' ? 1 : 0;
  const newX = player.x + dx;
  const newY = player.y + dy;

  if (newX < 0 || newX > 16 || newY < 0 || newY > 16 || boardData[newY][newX] === null) return;

  // Ê™¢Êü•ÊòØÂê¶ÊúâÂÖ∂‰ªñÁé©ÂÆ∂Âú®ÁõÆÊ®ôÊ†º
  const pushedPlayer = players.find(p => p.x === newX && p.y === newY);
  if (pushedPlayer) {
    const pushX = newX + dx;
    const pushY = newY + dy;

    if (
      pushX < 0 || pushX > 16 ||
      pushY < 0 || pushY > 16 ||
      boardData[pushY][pushX] === null ||
      players.some(p => p.x === pushX && p.y === pushY)
    ) {
      alert("ÁÑ°Ê≥ïÊé®ÈñãÂÖ∂‰ªñÁé©ÂÆ∂ÔºåÁßªÂãïÂ§±Êïó„ÄÇ");
      return;
    }

    pushedPlayer.cube = rotateCube(pushedPlayer.cube, dir);
    pushedPlayer.x = pushX;
    pushedPlayer.y = pushY;
    alert(`${pushedPlayer.name} Ë¢´ ${player.name} Êé®Âà∞‰∫ÜÊ†ºÂ≠ê ${boardData[pushY][pushX]}`);

    // Á¨¨‰∏âÊ¢ùË¶èÂâáÔºöÊé®Èñã‰∏çËß∏ÁôºÂÖ∂‰ªñË¶èÂâáÔºå‰ΩÜ‰ªçÊ™¢Êü•ÊòØÂê¶ÊîæÈÄê
    checkRule1(pushedPlayer);
  }

  const nextNum = boardData[newY][newX];
  const cellColor = colorMap[nextNum];
  const newCube = rotateCube(player.cube, dir);


  player.x = newX;
  player.y = newY;
  player.cube = newCube;

  checkRule1(player);

  // üõ°Ô∏è ÊîæÈÄêÂõû‰æÜÁöÑÈÇ£‰∏ÄËº™‰∏çÊ™¢Êü•Ë¶èÂâá4/5
  if (player.justBanished) {
    player.justBanished = false; // Âè™Áï•ÈÅéÈÄô‰∏ÄÂõûÂêà
  } else {
    checkRule4And5(player);
  }

  if (checkRule8(player)) {
    alert(`${player.name} Á¨¶ÂêàÁ¨¨ÂÖ´Ê¢ùË¶èÂâáÔºåÂèØÈ°çÂ§ñÈÄ≤Ë°å‰∏ÄÊ¨°ÁßªÂãïÔºÅ`);
    drawBoard();  // ÊèêÂâçÊõ¥Êñ∞Áï´Èù¢
    return;       // ‚úÖ ÊèêÂâç returnÔºå‰øùÁïôÂõûÂêà‰∏çÊèõ‰∫∫
  }

  checkRule6(player); // Â¶ÇÊûúÊ≤íËß∏Áôº Rule 8ÔºåÂÜçÊ™¢Êü• Rule 6



  currentPlayerIdx = (currentPlayerIdx + 1) % players.length;
  updateTurnInfo();
  drawBoard();
    }

    function updateTurnInfo() {
      document.getElementById("turnInfo").textContent = "Ëº™Âà∞„Äå" + players[currentPlayerIdx].name + "„ÄçÁßªÂãï„ÄÇ";
    }

    function drawBoard() {
      updateCubeVisuals();

      const board = document.getElementById("board");
      board.innerHTML = "";
      for (let y = 0; y < 17; y++) {
        for (let x = 0; x < 17; x++) {
          const val = boardData[y][x];
          const cell = document.createElement("div");
          cell.className = "cell";
          if (val !== null && val !== undefined) {
            cell.textContent = String(val);

            const color = colorMap[val];
            if (typeof color === "string") {
              cell.classList.add(color);
            } else {
              cell.classList.add("gray");
            }

            players.forEach(p => {
              if (p.x === x && p.y === y) {
                const div = document.createElement("div");
                div.className = 'playerCube';
                div.innerHTML = `${p.name}<br>${p.cube.top}`;
                cell.appendChild(div);
              }
            });
          } else {
            cell.classList.add('empty');
          }
          board.appendChild(cell);
        }
      }
    }

    function initSelectors() {
      const sel = document.getElementById("playerSelect");
      players.forEach((p, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = p.name;
        sel.appendChild(opt);
      });
    }

    initSelectors();
    drawBoard();

    function updateCubeVisuals() {
      const container = document.getElementById("cube-visuals");
      if (!container) return;

      let html = "<h3>Áé©ÂÆ∂ÊñπÂ°äË¶ñË¶∫È°ØÁ§∫</h3><div style='display: flex; gap: 20px; flex-wrap: wrap;'>";
      for (const p of players) {
        if (!p.cube) continue;
        const c = p.cube;

        html += `
          <div style="text-align:center;">
            <div style="font-weight:bold; margin-bottom: 5px;">${p.name}</div>
            <div style="
              width: 40px;
              height: 40px;
              margin: auto;
              background-color: ${c.top};
              border-left: 5px solid ${c.left};
              border-right: 5px solid ${c.right};
              border-top: 5px solid ${c.front};
              border-bottom: 5px solid ${c.back};
              box-sizing: border-box;
            "></div>

          </div>
        `;
      }
      html += "</div>";
      container.innerHTML = html;
    }



  </script>
</body>
</html>
